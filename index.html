<!DOCTYPE html>
<html>

<head>
    <title>Snakey Snake</title>
    <script src="./snake.js"></script>
    <script src="./food.js"></script>
    <script src="./utils.js"></script>
    <style>
        body {
            overflow: hidden;
            margin: 0;
            padding: 0
        }
    </style>
</head>

<body>
    <canvas id="snakeboard"></canvas>
</body>

<script>
    const board_border = 'GhostWhite';
    const board_background = "#B9D980";

    const snakeboard = document.getElementById("snakeboard");
    const snakeboard_ctx = snakeboard.getContext("2d");
    snakeboard.width = window.innerWidth;
    snakeboard.height = window.innerHeight;

    const middle_y = snakeboard.height / 2;

    let snake = new Snake(snakeboard_ctx, [
        { x: 240, y: middle_y },
        { x: 220, y: middle_y },
        { x: 200, y: middle_y },
        { x: 180, y: middle_y },
        { x: 160, y: middle_y }
    ]);

    let food = new Food(snakeboard_ctx, 10, 40);
    let justEat = true;

    document.addEventListener("keydown", keyboardControl);

    gameLoop();

    function gameLoop() {
        if (isGameEnded()) {
            alert('Game over');
            return;
        }
        setTimeout(function onTick() {
            if (snake.isPaused()) {
                return;
            }
            resetCanvas();
            snake.move();
            if (justEat) {
                food.genFood();
                justEat = false;
            }
            food.drawFood();
            if (snakeEating()) {
                snake.grow();
                justEat = true;
            }
            gameLoop();
        }, 100)
    }

    function snakeEating() {
        const foodCenter = {
            x: food.getX() + food.getFoodSize() / 2,
            y: food.getY() + food.getFoodSize() / 2
        }
        const snakeHead = snake.head();
        const snake_x1 = snakeHead.x;
        const snake_x2 = snakeHead.x + snake.snake_tile_w;
        const snake_y1 = snakeHead.y;
        const snake_y2 = snakeHead.y + snake.snake_tile_h;
        if (foodCenter.x >= snake_x1 && foodCenter.x <= snake_x2
            && foodCenter.y >= snake_y1 && foodCenter.y <= snake_y2) {
            return true;
        }
        return false;
    }

    function resetCanvas() {
        //  Select the colour to fill the drawing
        snakeboard_ctx.fillStyle = board_background;
        // Draw a "filled" rectangle to cover the entire canvas
        snakeboard_ctx.fillRect(0, 0, snakeboard.width, snakeboard.height);
        // Draw a "border" around the entire canvas
        snakeboard_ctx.lineWidth = 10;
        snakeboard_ctx.strokeStyle = board_border;
        snakeboard_ctx.strokeRect(0, 0, snakeboard.width, snakeboard.height);
    }

    function keyboardControl(event) {
        const KEY_LEFT = 37;
        const KEY_UP = 38;
        const KEY_RIGHT = 39;
        const KEY_DOWN = 40;
        const KEY_SPACE = 32;

        const keyPressed = event.keyCode;

        if (keyPressed === KEY_LEFT) {
            if (snake.isMovingUp()) snake.turnLeft();
            if (snake.isMovingDown()) snake.turnRight();
        }
        if (keyPressed === KEY_RIGHT) {
            if (snake.isMovingUp()) snake.turnRight();
            if (snake.isMovingDown()) snake.turnLeft();
        }
        if (keyPressed === KEY_UP) {
            if (snake.isMovingLeft()) snake.turnRight();
            if (snake.isMovingRight()) snake.turnLeft();
        }
        if (keyPressed === KEY_DOWN) {
            if (snake.isMovingLeft()) snake.turnLeft();
            if (snake.isMovingRight()) snake.turnRight();
        }
        if (keyPressed === KEY_SPACE) {
            snake.pauseOrResumeMoving();
            if (!snake.isPaused()) {
                gameLoop();
            }
        }
    }

    function isGameEnded() {
        if (snake.isCollide()) {
            return true;
        }
        const hitLeftWall = snake.head().x < 0;
        const hitRightWall = snake.head().x > snakeboard.width - 10;
        const hitTopWall = snake.head().y < 0;
        const hitBottomWall = snake.head().y > snakeboard.height - 10;
        return hitLeftWall || hitRightWall || hitTopWall || hitBottomWall;
    }

</script>

</html>